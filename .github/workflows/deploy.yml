name: Auto Deploy to EC2 on Push to Main

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: âœ… Checkout code
      uses: actions/checkout@v3

    # ----------- FRONTEND ----------
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '22'

    - name: ğŸ“¦ Install & Build Frontend
      run: |
        cd Frontend/WebClient
        npm install
        npm run build
        ls -la dist

    # ----------- BACKEND -----------
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.x'

    - name: ğŸ“¦ Publish Backend
      run: dotnet publish -c Release -o publish
      working-directory: Backend.Api


 # ----------- PREPARE SERVER (Optional, if needed for first time or permissions) -----------
    - name: ğŸ“¦ Prepare Database Directory on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          DB_DIR="/var/app_data/my_backend_db" # << THAY Äá»”I Náº¾U Cáº¦N
          APP_USER="${{ secrets.EC2_USER }}" # Hoáº·c user cá»¥ thá»ƒ cháº¡y service backend náº¿u khÃ¡c
                                            # VÃ­ dá»¥: náº¿u service cháº¡y vá»›i user 'mybackenduser'
                                            # APP_USER="mybackenduser"

          echo "Ensuring database directory $DB_DIR exists..."
          sudo mkdir -p $DB_DIR
          echo "Setting ownership of $DB_DIR to $APP_USER..."
          sudo chown -R $APP_USER:$APP_USER $DB_DIR # Äáº£m báº£o user cháº¡y app cÃ³ quyá»n
          sudo chmod -R 700 $DB_DIR # Quyá»n chá»‰ cho user sá»Ÿ há»¯u (an toÃ n hÆ¡n)
                                    # Hoáº·c 755 náº¿u group cÅ©ng cáº§n Ä‘á»c/execute
          echo "Database directory prepared."


    # ----------- CLEAN REMOTE FOLDERS -----------
    - name: ğŸ§¹ Clean remote frontend folder
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo rm -rf /var/www/html/*
          sudo mkdir -p /var/www/html
          sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} /var/www/html

    - name: ğŸ§¹ Clean remote backend folder
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo rm -rf /home/${{ secrets.EC2_USER }}/app/backend/*
          sudo mkdir -p /home/${{ secrets.EC2_USER }}/app/backend
          sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} /home/${{ secrets.EC2_USER }}/app/backend

    # ---------- UPLOAD FRONTEND ----------
    - name: ğŸ“¤ Upload Frontend to EC2 (~/webclient)
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "./Frontend/WebClient/dist"
        target: "/home/${{ secrets.EC2_USER }}/webclient/" # ÄÃ£ sá»­a Ä‘Æ°á»ng dáº«n target
        debug: true

    - name: ğŸšš Move Frontend to Nginx folder
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo rm -rf /var/www/html/*
          sudo mv /home/${{ secrets.EC2_USER }}/webclient/Frontend/WebClient/dist/* /var/www/html/ # ÄÃ£ sá»­a Ä‘Æ°á»ng dáº«n mv
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html


    # ---------- UPLOAD BACKEND ----------
    - name: ğŸš€ Upload Backend to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: Backend.Api/publish/
        target: /home/${{ secrets.EC2_USER }}/app/backend/
        overwrite: true

# ---------- SSH & RESTART ----------
    - name: âš™ï¸ Configure Backend Environment and Restart Service
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "Updating systemd service environment variables for backend..."

          # Äá»‹nh nghÄ©a tÃªn service vÃ  Ä‘Æ°á»ng dáº«n Ä‘áº¿n thÆ° má»¥c drop-in
          SERVICE_NAME="my-backend.service" # << Äáº¢M Báº¢O TÃŠN NÃ€Y CHÃNH XÃC Vá»šI SERVICE Cá»¦A Báº N
          OVERRIDE_DIR="/etc/systemd/system/${SERVICE_NAME}.d"
          OVERRIDE_FILE="$OVERRIDE_DIR/99-app-secrets.conf" # TÃªn file drop-in, sá»‘ 99 Ä‘áº£m báº£o nÃ³ Ä‘Æ°á»£c load cuá»‘i cÃ¹ng

          # Táº¡o thÆ° má»¥c drop-in náº¿u chÆ°a tá»“n táº¡i
          sudo mkdir -p $OVERRIDE_DIR

          # Táº¡o hoáº·c ghi Ä‘Ã¨ file drop-in vá»›i cÃ¡c biáº¿n mÃ´i trÆ°á»ng má»›i
          # Sá»­ dá»¥ng tee Ä‘á»ƒ ghi ná»™i dung vÃ  Ä‘áº£m báº£o quyá»n sudo
          echo "[Service]" | sudo tee $OVERRIDE_FILE > /dev/null
          echo "Environment=\"ASPNETCORE_ENVIRONMENT=Production\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          
          echo "Environment=\"ConnectionStrings__DefaultConnection=${{ secrets.PROD_DB_CONNECTION_STRING }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          echo "Environment=\"Jwt__Key=${{ secrets.PROD_JWT_KEY }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          echo "Environment=\"ImgBB__ApiKey=${{ secrets.PROD_IMGBB_APIKEY }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null
          echo "Environment=\"SmtpSettings__Password=${{ secrets.PROD_SMTP_PASSWORD }}\"" | sudo tee -a $OVERRIDE_FILE > /dev/null

          echo "Reloading systemd daemon and restarting service..."
          sudo systemctl daemon-reload
          sudo systemctl restart ${SERVICE_NAME}

          echo "Restarting Nginx..."
          sudo systemctl reload nginx

          echo "âœ… Deployment done!"
          echo "Äá»ƒ xÃ¡c minh biáº¿n mÃ´i trÆ°á»ng, SSH vÃ o server vÃ  cháº¡y: sudo systemctl show ${SERVICE_NAME} --property=Environment"
